{% extends "orders/layout.html" %}

{% block head %}
<title>Materiál</title>
<style>
    .btn-square-xl {
        width: 21vw !important;
        max-width: 100% !important;
        max-height: 100% !important;
        height: 21vw !important;
        text-align: center;
        padding: 0px;
        font-size: 4vw !important;
        margin-bottom: 5px;
    }
    .button {
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

{% endblock %}

{% block body %}
<h1 class="heading">Materiál</h1>


<!-- Creates a big button that sets the attention to false and the background color to white-->
<div class="button">
    <button type="button" class="btn btn-danger btn-square-xl" onclick="attention = false; document.body.style.background = '#FFFFFF'">Vidím</button>
</div>
{% csrf_token %}
<!-- Just the usual headings that dissappear when nothing is there to show-->

<div id="rozmitacka">
    <h1  class="heading" id="rozmitacka_heading">Rozmítačka</h1>
</div>
<div id="hoblovani">
    <h1 class="heading" id="hoblovani_heading">Hoblování</h1>
</div>

<script>
    // this function returns true if arrays have the exact same things inside in python if arr1 == arr2
    function arraysEqual(a, b) {
    if (a === b) return true;
    if (a == null || b == null) return false;
    if (a.length !== b.length) return false;

    for (var i = 0; i < a.length; ++i) {
      if (a[i] !== b[i]) return false;
    }
    return true;
  }
    // innitializing a bunch of variables that are needed later
    var r = [];
    var h = [];
    var attention = false;
    var flash = true;
    let rozmitacka = document.getElementById("rozmitacka");
    let hoblovani = document.getElementById("hoblovani")
    var r_visible = [];
    var h_visible = [];
    // create event listener, that looks for clicks
    document.addEventListener("click", event => {
        const element = event.target;
        // if the clicked element has "hide" class name, we delete its parent element
        // it sents an ajax POST request, that will set the order's material field to false
        if (element.className.includes("hide")) {
            $.ajax({
                type:"POST",
                url: "{% url 'orders:getMaterial' %}",
                data:{
                    id:element.parentElement.id,
                    table:element.parentElement.className,
                    csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                },
                success: function(data){
                    document.body.style.background = "#FFFFFF"
                }
            })
            // check which table is it
            id = parseInt(element.parentElement.id);
            if (element.parentElement.className == "r") {
                if (r_visible.includes(id)) {
                    const index = r_visible.indexOf(id)
                    if (index > -1){
                        r_visible.splice(index, 1);
                        element.parentElement.remove();
                    }
                    
                }
            } if (element.parentElement.className == "h") {
                if (h_visible.includes(id)) {
                    const index = h_visible.indexOf(id)
                    if (index > -1){
                        h_visible.splice(index, 1);
                        element.parentElement.remove();
                    }
                }
            }
            
        }
    });
    $(document).ready(function(){
        // create a reccuring function
        setInterval(function(){
            // get the orders, that need material
            $.ajax({
                type:'GET',
                url: "{% url 'orders:getMaterial' %}",
                success: function(response){
                    // create 2 variables for 2 tables
                    r = response.r
                    h = response.h
                    if (!arraysEqual(r_visible, r) || !arraysEqual(h_visible, h)) {
                        if (r_visible != [] || h_visible != []){
                            attention = true;
                        }
                    }
                    // if a table has something inside it, flash the screen
                    if (r.length != 0 || h.length != 0) {
                        document.getElementById("rozmitacka_heading").style.display = "block";
                        document.getElementById("hoblovani_heading").style.display = "block";
                        if (attention == true) {
                            if (flash == true) {
                                document.body.style.background = "#FF0000"
                                flash = !flash;
                            }else {
                                document.body.style.background = "#FFFFFF"
                                flash = !flash;
                            }
                        }
                        // run 2 for loops that add information for each order from both tables
                        {% for order in rozmitacka %}
                        if (r.includes({{ order.id }}) && !r_visible.includes({{ order.id }})){
                            var temp = '<div class="r" id="{{ order.id }}"> <h1><a class="mb-0" style="color: #00F; text-decoration: none;" href="{% url "orders:r_info" order.id %}">Objednávka číslo {{order.id}}</a></h1><button type="button" class="btn btn-primary btn-square-s hide">Smazat</button> <div class="detailsMO" id="r{{ order.id }}"> <div class="row" style="margin-top: 1rem;"> <div class="col-sm-3"> <h1 class="mb-0">Zákazník:</h1></div> <div class="col-sm-9   text-secondary"> {{ order.zakaznik }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Materiál:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.material }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Umístění materiálu:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.umisteni_materialu }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Požadovaný rozměr:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.pozadovany_rozmer }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Požadovaná délka:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.pozadovana_delka }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Poznámka:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.poznamka }}</div> </div> <hr style="height:5px; opacity:1;"> </div><br> <div>';
                            rozmitacka.innerHTML += temp;
                            r_visible.push({{ order.id }});
                        }
                        {% endfor %}
                        {% for order in hoblovani %}
                        if (h.includes({{ order.id }}) && !h_visible.includes({{ order.id }})){
                            var temp = '<div class="h" id="{{ order.id }}"> <h1><a class="mb-0" style="color: #00F; text-decoration: none;" href="{% url "orders:h_info" order.id %}">Objednávka číslo {{order.id}}</a></h1><button type="button" class="btn btn-primary btn-square-s hide">Smazat</button> <div class="detailsMO" id="r{{ order.id }}"> <div class="row" style="margin-top: 1rem;"> <div class="col-sm-3"> <h1 class="mb-0">Zákazník:</h1></div> <div class="col-sm-9   text-secondary"> {{ order.zakaznik }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Skladový materiál:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.skladovy_material }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Požadovaný rozměr:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.pozadovany_rozmer }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Požadovaná délka:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.pozadovana_delka }}</div> </div> <hr> <div class="row"> <div class="col-sm-3"> <h6 class="mb-0">Poznámka:</h6> </div> <div class="col-sm-9   text-secondary"> {{ order.poznamka }}</div> </div> <hr style="height:5px; opacity:1;"> </div> </div>';
                            hoblovani.innerHTML += temp;
                            h_visible.push({{ order.id }});
                        }
                        {% endfor %}
                    } else {
                        document.getElementById("rozmitacka_heading").style.display = "none";
                        document.getElementById("hoblovani_heading").style.display = "none";
                    }
                }
            });
        },300);
    });
</script>
{% endblock %}